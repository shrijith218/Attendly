<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendly</title>

  <!-- Barcode scanning library -->
  <script src="https://unpkg.com/html5-qrcode"></script>
  
  <link rel="icon" href="Scanner Icon.png"/>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f8ba37;
      min-height: 100vh;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 20px;
    }
    header { text-align: center; margin-bottom: 20px; }
    header img { width: 200px; display: block; margin: 0 auto 10px; }
    .container {
      background: #fff; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.15);
      padding: 20px; width: 100%; max-width: 420px; text-align: center;
    }
    .video-wrapper { width: 100%; height: 300px; background: #dfe6e9; border-radius: 10px; overflow: hidden; position: relative; }
    #reader { position: absolute; width:100%; height:100%; left:0; top:0; object-fit: cover; }
    #result { margin-top: 12px; color: #2d3436; font-weight: bold; }
    .controls { margin-top: 12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    input[type="date"], input[type="number"], button { padding: 8px 12px; border-radius:6px; border:1px solid #ccc; }
    .manual { margin-top: 18px; text-align:center; }
  </style>
</head>
<body>
  <header>
    <img src="Scanner_logo.png" alt="Scanner Icon" />
    <h2>Attendly ‚Äî Scan Your Barcode</h2>
  </header>

  <div class="container">
    <div class="video-wrapper">
      <div id="reader"></div>
    </div>

    <div class="manual">
      <h4>Manual Entry</h4>
      <input type="number" id="manualAdmission" placeholder="Enter Admission Number" />
      <button id="manualSubmit">Submit</button>
    </div>

    <p id="result">Result: <span id="resText">Waiting...</span></p>

    <div class="controls">
      <input type="date" id="datePicker" />
      <button id="downloadBtn">‚¨áÔ∏è Download Excel</button>
    </div>
  </div>

  <script>
    // --- Configuration ---
    const BACKEND_URL = "http://localhost:3001"; // Change this to your backend URL if deployed

    // --- State ---
    let html5QrCode = null;
    let lastScanned = null;
    let isScanning = false;

    // Helper: format IST datetime string
    function formatISTDateTime() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      const ist = new Date(utc + 5.5 * 3600000);
      const pad = n => n.toString().padStart(2, '0');
      return `${ist.getFullYear()}-${pad(ist.getMonth()+1)}-${pad(ist.getDate())} ${pad(ist.getHours())}:${pad(ist.getMinutes())}:${pad(ist.getSeconds())}`;
    }

    // Set result text
    function setResult(text) {
      document.getElementById('resText').innerText = text;
    }

    // Send attendance log to backend
    async function sendLog({ barcode, admissionNumber, time }) {
      const payload = { time: time || formatISTDateTime() };
      if (barcode) payload.barcode = String(barcode);
      if (admissionNumber) payload.admissionNumber = String(admissionNumber);

      try {
        const res = await fetch(`${BACKEND_URL}/scan`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (res.ok && data?.success) {
          setResult(`‚úÖ Saved: ${data.student.name} (${data.student.admission_number})`);
        } else if (data?.error) {
          setResult(`‚ùå ${data.error}`);
        } else if (data?.message) {
          setResult(data.message);
        } else {
          setResult('‚ùå Unknown server response');
        }
      } catch (err) {
        console.error("sendLog error:", err);
        setResult("‚ùå Network or server error");
      }
    }

    // Barcode scan success callback
    async function onScanSuccess(decodedText, decodedResult) {
      const cleanedText = decodedText.replace(/^]C1/, '').trim();
      if (isScanning || cleanedText === lastScanned) return;
      isScanning = true;
      lastScanned = cleanedText;

      navigator.vibrate?.(200);
      setResult(`Scanning... ${cleanedText}`);

      const formattedTime = formatISTDateTime();
      sendLog({ barcode: cleanedText, time: formattedTime })
        .finally(() => { setTimeout(() => { isScanning = false; }, 1500); });
    }

    // Start barcode scanner
    function startScanner() {
      Html5Qrcode.getCameras().then(devices => {
        if (!devices?.length) {
          setResult('‚ùå No camera devices found');
          return;
        }
        const rear = devices.find(d => /back|rear|environment|wide/i.test(d.label));
        const cameraId = (rear && rear.id) || devices[0].id;

        if (html5QrCode) {
          html5QrCode.stop().catch(() => {}).finally(() => {
            html5QrCode.clear().catch(() => {});
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(cameraId, { fps: 10, qrbox: 250 }, onScanSuccess)
              .catch(err => { setResult("‚ùå Camera start error: " + err); });
          });
        } else {
          html5QrCode = new Html5Qrcode("reader");
          html5QrCode.start(cameraId, { fps: 10, qrbox: 250 }, onScanSuccess)
            .catch(err => { setResult("‚ùå Camera start error: " + err); });
        }
      }).catch(err => {
        setResult("‚ùå Camera permission or detection error");
      });
    }

    // Manual entry submit
    document.getElementById('manualSubmit').addEventListener('click', async () => {
      const admissionNumber = document.getElementById('manualAdmission').value.trim();
      if (!admissionNumber) {
        alert("Please enter an admission number.");
        return;
      }
      setResult('üì• Submitting manual entry...');

      sendLog({ admissionNumber, time: formatISTDateTime() });
      document.getElementById('manualAdmission').value = '';
    });

    // Download Excel button
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const date = document.getElementById('datePicker').value;
      if (!date) { alert("Please select a date."); return; }
      const url = `${BACKEND_URL}/download-excel?date=${encodeURIComponent(date)}`;
      window.open(url, "_blank");
    });

    // Initialization
    window.addEventListener('load', async () => {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        console.warn('Camera may be blocked without HTTPS');
      }
      startScanner();
    });

    // Cleanup
    window.addEventListener('beforeunload', () => {
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {}).finally(() => { html5QrCode.clear().catch(() => {}); });
      }
    });
  </script>
</body>
</html>