<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Attendly</title>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
  <link rel="icon" href="Scanner Icon.png"/>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f8ba37;
      min-height: 100vh;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
      padding: 20px;
    }
    header { text-align: center; margin-bottom: 20px; }
    header img { width: 200px; display: block; margin: 0 auto 10px; }
    .container {
      background: #fff; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.15);
      padding: 20px; width: 100%; max-width: 420px; text-align: center;
    }
    .video-wrapper { width: 100%; height: 300px; background: #dfe6e9; border-radius: 10px; overflow: hidden; position: relative; }
    #reader { position: absolute; width:100%; height:100%; left:0; top:0; object-fit: cover; }
    #result { margin-top: 12px; color: #2d3436; font-weight: bold; }
    .controls { margin-top: 12px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    input[type="date"], input[type="number"], button { padding: 8px 12px; border-radius:6px; border:1px solid #ccc; }
    .manual { margin-top: 18px; text-align:center; }
    #faceVideo {
      display: none;
      width: 320px;
      height: 240px;
      margin: 10px auto;
      border: 2px solid #333;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <header>
    <img src="Scanner_logo.png" alt="Scanner Icon" />
    <h2>Attendly ‚Äî Scan Your Barcode or Face</h2>
  </header>

  <div class="container">
    <div class="video-wrapper">
      <div id="reader"></div>
    </div>

    <!-- Video for face-api -->
    <video id="faceVideo" autoplay muted></video>

    <div class="manual">
      <h4>Manual Entry</h4>
      <input type="number" id="manualAdmission" placeholder="Enter Admission Number" />
      <button id="manualSubmit">Submit</button>
    </div>

    <p id="result">Result: <span id="resText">Waiting...</span></p>

    <div class="controls">
      <input type="date" id="datePicker" />
      <button id="downloadBtn">‚¨áÔ∏è Download Excel</button>
    </div>
  </div>

  <script>
    // --- config ---
    const BACKEND_URL = "https://proto1-4p67.onrender.com"; // change to your backend URL if different

    // --- scanning state ---
    let html5QrCode = null;
    let lastScanned = null;
    let isScanning = false;

    // face-api models path
    const MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';

    let faceVideo = document.getElementById('faceVideo');

    // Load face-api models
    async function loadFaceModels() {
      await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
      await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
      await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
      console.log('‚úÖ Face-api models loaded');
      // Start webcam for face capture
      startFaceVideo();
    }

    // Start webcam for face capture
    async function startFaceVideo() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        faceVideo.srcObject = stream;
        faceVideo.style.display = 'block';
      } catch (err) {
        console.error('‚ùå Face video error:', err);
        setResult('‚ùå Face webcam error or permission denied');
      }
    }

    // Get face descriptor from video
    async function getFaceDescriptor() {
      if (faceVideo.readyState !== 4) return null;

      const detection = await faceapi.detectSingleFace(faceVideo, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
      if (!detection) {
        return null;
      }
      return detection.descriptor; // Float32Array
    }

    // format datetime in IST (YYYY-MM-DD HH:MM:SS)
    function formatISTDateTime() {
      const now = new Date();
      const utc = now.getTime() + now.getTimezoneOffset() * 60000;
      const ist = new Date(utc + 5.5 * 3600000);
      const pad = n => n.toString().padStart(2, '0');
      return `${ist.getFullYear()}-${pad(ist.getMonth()+1)}-${pad(ist.getDate())} ${pad(ist.getHours())}:${pad(ist.getMinutes())}:${pad(ist.getSeconds())}`;
    }

    // Convert Float32Array to plain array for JSON serialization
    function descriptorToArray(descriptor) {
      return Array.from(descriptor);
    }

    // Set result text helper
    function setResult(text) {
      document.getElementById('resText').innerText = text;
    }

    // Send log to backend. Accepts barcode, admissionNumber, and faceDescriptor
    async function sendLog({ barcode, admissionNumber, faceDescriptor, time }) {
      const payload = { time: time || formatISTDateTime() };
      if (barcode) payload.barcode = String(barcode);
      if (admissionNumber) payload.admissionNumber = String(admissionNumber);
      if (faceDescriptor) payload.faceDescriptor = descriptorToArray(faceDescriptor);

      try {
        const res = await fetch(`${BACKEND_URL}/scan`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
        const data = await res.json();
        if (res.ok && data?.success) {
          setResult(`‚úÖ Saved: ${data.student.name} (${data.student.admission_number})`);
        } else if (data?.error) {
          setResult(`‚ùå ${data.error}`);
        } else if (data?.message) {
          setResult(data.message);
        } else {
          setResult('‚ùå Unknown server response');
        }
      } catch (err) {
        console.error("sendLog error:", err);
        setResult("‚ùå Network or server error");
      }
    }

    // Called on successful barcode scan
    async function onScanSuccess(decodedText, decodedResult) {
      const cleanedText = decodedText.replace(/^]C1/, '').trim();
      // debounce duplicates
      if (isScanning || cleanedText === lastScanned) return;
      isScanning = true;
      lastScanned = cleanedText;

      navigator.vibrate?.(200); // feedback if supported
      setResult(`Scanning... ${cleanedText}`);

      // Get face descriptor from webcam
      const faceDescriptor = await getFaceDescriptor();

      const formattedTime = formatISTDateTime();
      sendLog({ barcode: cleanedText, faceDescriptor, time: formattedTime })
        .finally(() => {
          setTimeout(() => { isScanning = false; }, 1500);
        });
    }

    // Initialize barcode scanner camera
    function startScanner() {
      Html5Qrcode.getCameras().then(devices => {
        if (!devices || devices.length === 0) {
          setResult('‚ùå No camera devices found');
          return;
        }

        const rear = devices.find(d => /back|rear|environment|wide/i.test(d.label));
        const cameraId = (rear && rear.id) || devices[0].id;

        if (html5QrCode) {
          html5QrCode.stop().catch(() => {}).finally(() => {
            html5QrCode.clear().catch(() => {});
            html5QrCode = new Html5Qrcode("reader");
            html5QrCode.start(cameraId, { fps: 10, qrbox: 250 }, onScanSuccess, err => {
              console.warn("QR error:", err);
            }).catch(err => {
              console.error("start error:", err);
              setResult("‚ùå Camera start error: " + err);
            });
          });
        } else {
          html5QrCode = new Html5Qrcode("reader");
          html5QrCode.start(cameraId, { fps: 10, qrbox: 250 }, onScanSuccess, err => {})
            .catch(err => {
              console.error("start error:", err);
              setResult("‚ùå Camera start error: " + err);
            });
        }
      }).catch(err => {
        console.error("getCameras error:", err);
        setResult("‚ùå Camera permission or detection error");
      });
    }

    // Manual submit handler with face recognition
    document.getElementById('manualSubmit').addEventListener('click', async () => {
      const admissionNumber = document.getElementById('manualAdmission').value.trim();
      if (!admissionNumber) {
        alert("Please enter an admission number.");
        return;
      }
      setResult('üì• Capturing face and submitting manual entry...');

      // Capture face descriptor
      const faceDescriptor = await getFaceDescriptor();
      if (!faceDescriptor) {
        setResult('‚ùå No face detected. Please ensure face is visible to the camera.');
        return;
      }

      sendLog({ admissionNumber, faceDescriptor, time: formatISTDateTime() });
      document.getElementById('manualAdmission').value = '';
    });

    // Download Excel button
    document.getElementById('downloadBtn').addEventListener('click', () => {
      const date = document.getElementById('datePicker').value;
      if (!date) { alert("Please select a date."); return; }
      const url = `${BACKEND_URL}/download-excel?date=${encodeURIComponent(date)}`;
      window.open(url, "_blank");
    });

    // Start all on load
    window.addEventListener('load', async () => {
      if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
        console.warn('Camera may be blocked without HTTPS');
      }
      await loadFaceModels();
      startScanner();
    });

    // Cleanup on unload
    window.addEventListener('beforeunload', () => {
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {}).finally(() => { html5QrCode.clear().catch(() => {}); });
      }
      if (faceVideo.srcObject) {
        faceVideo.srcObject.getTracks().forEach(track => track.stop());
      }
    });
  </script>
</body>
</html>
